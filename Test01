import React, { useState, useEffect, useRef } from 'react';
import { 
  Activity, Zap, Sun, Droplet, TrendingUp, ShieldCheck, 
  BarChart3, UploadCloud, FileText, Cpu, CheckCircle2, ChevronRight, Download
} from 'lucide-react';

// --- HOOKS E COMPONENTES AUXILIARES ---

const useEcharts = () => {
  const [loaded, setLoaded] = useState(false);
  useEffect(() => {
    if (window.echarts) { setLoaded(true); return; }
    const script = document.createElement('script');
    script.src = 'https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js';
    script.async = true;
    script.onload = () => setLoaded(true);
    document.body.appendChild(script);
  }, []);
  return loaded;
};

const EChart = ({ option, style, className }) => {
  const chartRef = useRef(null);
  const chartInstance = useRef(null);

  useEffect(() => {
    if (chartRef.current && window.echarts) {
      if (!chartInstance.current) chartInstance.current = window.echarts.init(chartRef.current);
      chartInstance.current.setOption(option);
      const handleResize = () => chartInstance.current.resize();
      window.addEventListener('resize', handleResize);
      return () => {
        window.removeEventListener('resize', handleResize);
        if (chartInstance.current) { chartInstance.current.dispose(); chartInstance.current = null; }
      };
    }
  }, [option]);

  return <div ref={chartRef} style={style} className={className} />;
};

// --- CONFIGURAÇÕES DE GRÁFICOS DINÂMICOS ---

const getDonutOption = (data) => ({
  backgroundColor: 'transparent',
  title: {
    text: `${data.totalCapacity} MW`, subtext: 'Capacidade Ativa', left: 'center', top: 'center',
    textStyle: { color: '#ffffff', fontSize: 22, fontWeight: '900', textShadowBlur: 10, textShadowColor: 'rgba(255,255,255,0.2)' },
    subtextStyle: { color: '#00F0FF', fontSize: 12, fontWeight: 'bold' }
  },
  tooltip: { trigger: 'item', backgroundColor: 'rgba(11, 14, 20, 0.9)', borderColor: '#333', textStyle: { color: '#fff' } },
  legend: { bottom: '0%', left: 'center', textStyle: { color: '#A0AEC0' } },
  series: [{
    name: 'Capacidade (MW)', type: 'pie', radius: ['50%', '75%'], avoidLabelOverlap: false,
    itemStyle: { borderRadius: 10, borderColor: '#0B0E14', borderWidth: 4 },
    label: { show: false, position: 'center' },
    data: [
      { value: data.hydroCapacity, name: 'Hídrica', itemStyle: { color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: '#00F0FF' }, { offset: 1, color: '#0066FF' }]), shadowBlur: 20, shadowColor: 'rgba(0, 240, 255, 0.5)' } },
      { value: data.solarCapacity, name: 'Solar', itemStyle: { color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: '#B026FF' }, { offset: 1, color: '#5A00FF' }]), shadowBlur: 20, shadowColor: 'rgba(176, 38, 255, 0.5)' } }
    ]
  }]
});

const getAreaOption = () => ({
  backgroundColor: 'transparent',
  tooltip: { trigger: 'axis', axisPointer: { type: 'cross', label: { backgroundColor: '#6a7985' } }, backgroundColor: 'rgba(11, 14, 20, 0.9)', borderColor: '#333', textStyle: { color: '#fff' } },
  legend: { data: ['Base Hídrica Original', 'Aquisição Copel (2024)', 'Complexo Solar (2025)'], textStyle: { color: '#A0AEC0' }, top: 0 },
  grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
  xAxis: [{ type: 'category', boundaryGap: false, data: ['Pré-2023', '2023', '2024', '2025'], axisLine: { lineStyle: { color: '#4A5568' } }, axisLabel: { color: '#A0AEC0' } }],
  yAxis: [{ type: 'value', axisLine: { show: false }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }, axisLabel: { color: '#A0AEC0' } }],
  series: [
    { name: 'Base Hídrica Original', type: 'line', stack: 'Total', smooth: true, lineStyle: { width: 0 }, showSymbol: false, areaStyle: { opacity: 0.8, color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(0, 102, 255, 0.8)' }, { offset: 1, color: 'rgba(0, 102, 255, 0.1)' }]) }, data: [67.7, 67.7, 67.7, 67.7] },
    { name: 'Aquisição Copel (2024)', type: 'line', stack: 'Total', smooth: true, lineStyle: { width: 0 }, showSymbol: false, areaStyle: { opacity: 0.8, color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(0, 240, 255, 0.8)' }, { offset: 1, color: 'rgba(0, 240, 255, 0.1)' }]) }, data: [0, 0, 118.7, 118.7] },
    { name: 'Complexo Solar (2025)', type: 'line', stack: 'Total', smooth: true, lineStyle: { width: 2, color: '#B026FF', shadowBlur: 15, shadowColor: '#B026FF' }, showSymbol: true, symbolSize: 8, itemStyle: { color: '#B026FF', borderColor: '#fff', borderWidth: 2 }, areaStyle: { opacity: 0.8, color: new window.echarts.graphic.LinearGradient(0, 0, 0, 1, [{ offset: 0, color: 'rgba(176, 38, 255, 0.8)' }, { offset: 1, color: 'rgba(176, 38, 255, 0.1)' }]) }, data: [0, 0, 0, 161.0] }
  ]
});

const getRadarOption = () => ({
  backgroundColor: 'transparent',
  tooltip: { backgroundColor: 'rgba(11, 14, 20, 0.9)', textStyle: { color: '#fff' }, borderColor: '#333' },
  radar: {
    radius: '45%', center: ['50%', '50%'],
    indicator: [ { name: 'Comercialização', max: 100 }, { name: 'Hídrica', max: 100 }, { name: 'Solar', max: 100 }, { name: 'Soluções', max: 100 }, { name: 'PPAs', max: 100 } ],
    splitArea: { areaStyle: { color: ['rgba(255,255,255,0.02)', 'rgba(255,255,255,0.05)', 'rgba(255,255,255,0.08)', 'rgba(255,255,255,0.11)'] } },
    axisLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } }, splitLine: { lineStyle: { color: 'rgba(255,255,255,0.2)' } },
    axisName: { color: '#00F0FF', borderRadius: 3, padding: [3, 5] }
  },
  series: [{
    name: 'Score', type: 'radar',
    data: [{
      value: [100, 95, 85, 60, 90], name: 'Score Estratégico',
      areaStyle: { color: new window.echarts.graphic.RadialGradient(0.5, 0.5, 1, [{ color: 'rgba(0, 240, 255, 0.5)', offset: 0 }, { color: 'rgba(176, 38, 255, 0.5)', offset: 1 }]) },
      lineStyle: { width: 2, color: '#00F0FF', shadowBlur: 10, shadowColor: '#00F0FF' }, itemStyle: { color: '#00F0FF' }
    }]
  }]
});


// --- COMPONENTE PRINCIPAL (NEXUS APP) ---
export default function App() {
  const isEchartsLoaded = useEcharts();
  
  // Estados da Aplicação: 'upload' -> 'analyzing' -> 'dashboard'
  const [appState, setAppState] = useState('upload');
  const [fileData, setFileData] = useState(null);
  const [progress, setProgress] = useState(0);
  const [loadingMsg, setLoadingMsg] = useState('');
  
  // Estado para armazenar os dados extraídos "pela IA"
  const [dashboardData, setDashboardData] = useState(null);

  // --- MOCK DE DADOS RETORNADOS PELA "IA" APÓS LER O PDF ---
  const mockExtractedData = {
    companyName: "Energy Group",
    totalCapacity: 347.4,
    hydroCapacity: 186.4,
    solarCapacity: 161.0,
    activePlants: 25,
  };

  // --- FUNÇÃO DE EXPORTAÇÃO PARA HTML OFFLINE ---
  const handleDownloadHtml = () => {
    if (!dashboardData) return;

    // Constrói um HTML estático injetando os dados e as bibliotecas (Tailwind e ECharts)
    const htmlTemplate = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Analítico - ${dashboardData.companyName}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { background-color: #0B0E14; color: #cbd5e1; font-family: ui-sans-serif, system-ui, sans-serif; }
  </style>
</head>
<body class="p-6 sm:p-10 font-sans selection:bg-[#00F0FF] selection:text-black">
  <div class="max-w-7xl mx-auto">
    
    <!-- Header Offline -->
    <header class="mb-8 border-b border-white/10 pb-6 flex justify-between items-center">
      <div>
        <h1 class="text-3xl font-bold text-white flex items-center gap-3">
          <i data-lucide="zap" class="text-[#00F0FF] w-8 h-8"></i>
          ${dashboardData.companyName}
        </h1>
        <p class="text-slate-500 mt-1 ml-11 text-sm tracking-widest uppercase">Relatório Interativo Offline • Extraído via Nexus AI</p>
      </div>
    </header>

    <!-- Cards de KPIs -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative">
        <p class="text-slate-500 text-xs font-bold uppercase mb-1">Capacidade Total</p>
        <h3 class="text-4xl font-black text-white">${dashboardData.totalCapacity} <span class="text-lg text-[#00F0FF]">MW</span></h3>
      </div>
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative">
        <p class="text-slate-500 text-xs font-bold uppercase mb-1">Geração Hídrica</p>
        <h3 class="text-3xl font-black text-white">${dashboardData.hydroCapacity} <span class="text-lg text-[#0066FF]">MW</span></h3>
      </div>
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative">
        <p class="text-slate-500 text-xs font-bold uppercase mb-1">Complexo Solar</p>
        <h3 class="text-3xl font-black text-white">${dashboardData.solarCapacity} <span class="text-lg text-[#B026FF]">MWp</span></h3>
      </div>
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative">
        <p class="text-slate-500 text-xs font-bold uppercase mb-1">Usinas Ativas</p>
        <h3 class="text-3xl font-black text-white">${dashboardData.activePlants} <span class="text-lg text-slate-400">Ativos</span></h3>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6 col-span-1 lg:col-span-2">
        <h2 class="text-lg font-semibold text-white mb-4">Evolução Histórica de Capacidade</h2>
        <div id="chart-area" style="height: 320px; width: 100%;"></div>
      </div>
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Diversificação da Matriz</h2>
        <div id="chart-donut" style="height: 320px; width: 100%;"></div>
      </div>
      <div class="bg-[#151A23] border border-white/5 rounded-2xl p-6">
        <h2 class="text-lg font-semibold text-white mb-4">Índice de Maturidade</h2>
        <div id="chart-radar" style="height: 320px; width: 100%;"></div>
      </div>
    </div>
  </div>

  <script>
    // Inicializa os ícones
    lucide.createIcons();
    
    // Configura e renderiza os gráficos ECharts com os dados extraídos
    const getDonutOption = () => ({
      backgroundColor: 'transparent',
      title: { text: '${dashboardData.totalCapacity} MW', subtext: 'Capacidade Ativa', left: 'center', top: 'center', textStyle: { color: '#ffffff', fontSize: 22, fontWeight: '900' }, subtextStyle: { color: '#00F0FF', fontSize: 12, fontWeight: 'bold' } },
      tooltip: { trigger: 'item', backgroundColor: 'rgba(11, 14, 20, 0.9)', borderColor: '#333', textStyle: { color: '#fff' } },
      legend: { bottom: '0%', left: 'center', textStyle: { color: '#A0AEC0' } },
      series: [{
        name: 'Capacidade (MW)', type: 'pie', radius: ['50%', '75%'], avoidLabelOverlap: false,
        itemStyle: { borderRadius: 10, borderColor: '#0B0E14', borderWidth: 4 }, label: { show: false },
        data: [
          { value: ${dashboardData.hydroCapacity}, name: 'Hídrica', itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'#00F0FF'},{offset:1,color:'#0066FF'}]) } },
          { value: ${dashboardData.solarCapacity}, name: 'Solar', itemStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'#B026FF'},{offset:1,color:'#5A00FF'}]) } }
        ]
      }]
    });

    const getAreaOption = () => ({
      backgroundColor: 'transparent',
      tooltip: { trigger: 'axis', backgroundColor: 'rgba(11, 14, 20, 0.9)', borderColor: '#333', textStyle: { color: '#fff' } },
      legend: { data: ['Base Hídrica Original', 'Aquisição Copel (2024)', 'Complexo Solar (2025)'], textStyle: { color: '#A0AEC0' } },
      grid: { left: '3%', right: '4%', bottom: '3%', containLabel: true },
      xAxis: [{ type: 'category', boundaryGap: false, data: ['Pré-2023', '2023', '2024', '2025'], axisLabel: { color: '#A0AEC0' } }],
      yAxis: [{ type: 'value', splitLine: { lineStyle: { color: 'rgba(255,255,255,0.05)' } }, axisLabel: { color: '#A0AEC0' } }],
      series: [
        { name: 'Base Hídrica Original', type: 'line', stack: 'Total', smooth: true, showSymbol: false, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'rgba(0,102,255,0.8)'},{offset:1,color:'rgba(0,102,255,0.1)'}]) }, data: [67.7, 67.7, 67.7, 67.7] },
        { name: 'Aquisição Copel (2024)', type: 'line', stack: 'Total', smooth: true, showSymbol: false, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'rgba(0,240,255,0.8)'},{offset:1,color:'rgba(0,240,255,0.1)'}]) }, data: [0, 0, 118.7, 118.7] },
        { name: 'Complexo Solar (2025)', type: 'line', stack: 'Total', smooth: true, showSymbol: true, areaStyle: { color: new echarts.graphic.LinearGradient(0,0,0,1, [{offset:0,color:'rgba(176,38,255,0.8)'},{offset:1,color:'rgba(176,38,255,0.1)'}]) }, itemStyle: { color: '#B026FF' }, data: [0, 0, 0, 161.0] }
      ]
    });

    const getRadarOption = () => ({
      backgroundColor: 'transparent',
      radar: {
        radius: '55%', center: ['50%', '50%'],
        indicator: [ { name: 'Comercialização', max: 100 }, { name: 'Hídrica', max: 100 }, { name: 'Solar', max: 100 }, { name: 'Soluções', max: 100 }, { name: 'PPAs', max: 100 } ],
        axisName: { color: '#00F0FF' }, splitArea: { areaStyle: { color: ['rgba(255,255,255,0.02)','rgba(255,255,255,0.05)'] } }
      },
      series: [{
        type: 'radar', data: [{ value: [100, 95, 85, 60, 90], name: 'Score', areaStyle: { color: 'rgba(176,38,255,0.3)' }, itemStyle: { color: '#00F0FF' }, lineStyle: { color: '#00F0FF' } }]
      }]
    });

    // Inicia os gráficos
    const cArea = echarts.init(document.getElementById('chart-area')); cArea.setOption(getAreaOption());
    const cDonut = echarts.init(document.getElementById('chart-donut')); cDonut.setOption(getDonutOption());
    const cRadar = echarts.init(document.getElementById('chart-radar')); cRadar.setOption(getRadarOption());
    
    // Responsividade nativa
    window.addEventListener('resize', () => { cArea.resize(); cDonut.resize(); cRadar.resize(); });
  </script>
</body>
</html>`;

    // Dispara o download nativo do arquivo
    const blob = new Blob([htmlTemplate], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Relatorio_${dashboardData.companyName.replace(/\s+/g, '_')}_Offline.html`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // Lógica de Upload (Drag & Drop)
  const handleDragOver = (e) => e.preventDefault();
  const handleDrop = (e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file && file.type === 'application/pdf') processFile(file);
    else alert("Por favor, envie apenas arquivos .PDF");
  };
  const handleFileSelect = (e) => {
    const file = e.target.files[0];
    if (file) processFile(file);
  };

  // Pipeline de Processamento (Simulação de IA)
  const processFile = (file) => {
    setFileData(file);
    setAppState('analyzing');
    setProgress(0);
    
    // Simulação de tempo de processamento em etapas
    const steps = [
      { progress: 15, msg: "Extraindo texto via PDF.js...", delay: 500 },
      { progress: 40, msg: "Aplicando NLP para contexto semântico...", delay: 1500 },
      { progress: 65, msg: "Identificando KPIs e Entidades Estratégicas...", delay: 2500 },
      { progress: 85, msg: "Estruturando JSON de saída...", delay: 3500 },
      { progress: 100, msg: "Gerando Interface Gráfica...", delay: 4500 }
    ];

    steps.forEach((step) => {
      setTimeout(() => {
        setProgress(step.progress);
        setLoadingMsg(step.msg);
        if (step.progress === 100) {
          setTimeout(() => {
            setDashboardData(mockExtractedData); // Popula com os dados da "IA"
            setAppState('dashboard');
          }, 800); // pequeno delay final antes da transição
        }
      }, step.delay);
    });
  };

  // Resetar App
  const resetApp = () => {
    setAppState('upload');
    setFileData(null);
    setDashboardData(null);
  };

  if (!isEchartsLoaded) return <div className="min-h-screen bg-[#0B0E14]" />;

  // --- TELA 1: UPLOAD ---
  if (appState === 'upload') {
    return (
      <div className="min-h-screen bg-[#0B0E14] text-slate-300 flex flex-col items-center justify-center p-6 font-sans">
        <div className="max-w-3xl w-full">
          <div className="text-center mb-10">
            <div className="inline-flex items-center justify-center p-4 bg-[#151A23] rounded-2xl mb-6 shadow-[0_0_30px_rgba(0,240,255,0.1)] border border-white/5">
              <Cpu className="w-10 h-10 text-[#00F0FF]" />
            </div>
            <h1 className="text-4xl font-black text-white mb-4 tracking-tight">Nexus <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#00F0FF] to-[#B026FF]">Doc2Dash</span></h1>
            <p className="text-slate-400 text-lg">Faça upload de um PDF com relatórios ou apresentações institucionais. Nossa IA extrairá os KPIs estruturais e construirá um dashboard analítico em segundos.</p>
          </div>

          <label 
            onDragOver={handleDragOver} 
            onDrop={handleDrop}
            className="group relative flex flex-col items-center justify-center w-full h-80 border-2 border-dashed border-slate-700 rounded-3xl bg-[#151A23]/50 hover:bg-[#151A23] hover:border-[#00F0FF]/50 transition-all duration-300 cursor-pointer overflow-hidden"
          >
            {/* Glow effect on hover */}
            <div className="absolute inset-0 bg-gradient-to-b from-[#00F0FF]/0 to-[#00F0FF]/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
            
            <UploadCloud className="w-16 h-16 text-slate-500 group-hover:text-[#00F0FF] mb-6 transition-colors duration-300" />
            <h3 className="text-2xl font-bold text-white mb-2">Arraste seu PDF aqui</h3>
            <p className="text-slate-500 mb-6">ou clique para procurar no seu computador</p>
            
            <div className="flex items-center gap-2 bg-slate-800/50 px-4 py-2 rounded-full border border-slate-700 group-hover:border-[#B026FF]/50 transition-colors">
              <FileText className="w-4 h-4 text-[#B026FF]" />
              <span className="text-xs font-semibold text-slate-300 tracking-wider">APENAS ARQUIVOS .PDF</span>
            </div>
            
            <input type="file" className="hidden" accept=".pdf" onChange={handleFileSelect} />
          </label>
        </div>
      </div>
    );
  }

  // --- TELA 2: ANALYZING (LOADING CYBERPUNK) ---
  if (appState === 'analyzing') {
    return (
      <div className="min-h-screen bg-[#0B0E14] text-slate-300 flex flex-col items-center justify-center p-6 font-sans">
        <div className="max-w-md w-full text-center">
          <div className="relative w-32 h-32 mx-auto mb-8">
            <svg className="animate-spin w-full h-full text-[#151A23]" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" strokeWidth="2" stroke="currentColor" />
              <circle cx="50" cy="50" r="45" fill="none" strokeWidth="4" stroke="url(#gradient)" strokeDasharray="70 200" strokeLinecap="round" />
              <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                  <stop offset="0%" stopColor="#00F0FF" />
                  <stop offset="100%" stopColor="#B026FF" />
                </linearGradient>
              </defs>
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <FileText className="w-8 h-8 text-white animate-pulse" />
            </div>
          </div>
          
          <h2 className="text-2xl font-bold text-white mb-2">Processando {fileData?.name || 'Documento'}...</h2>
          <p className="text-[#00F0FF] font-mono text-sm mb-8 h-6">{loadingMsg}</p>
          
          <div className="w-full h-2 bg-slate-800 rounded-full overflow-hidden mb-2 border border-white/5">
            <div 
              className="h-full bg-gradient-to-r from-[#00F0FF] to-[#B026FF] transition-all duration-500 ease-out relative"
              style={{ width: `${progress}%` }}
            >
              <div className="absolute inset-0 bg-white/20 animate-[shimmer_1s_infinite] w-full"></div>
            </div>
          </div>
          <div className="text-right text-xs font-mono text-slate-500">{progress}%</div>
        </div>
      </div>
    );
  }

  // --- TELA 3: DASHBOARD GERADO ---
  if (appState === 'dashboard' && dashboardData) {
    return (
      <div className="min-h-screen bg-[#0B0E14] text-slate-300 font-sans p-6 overflow-x-hidden selection:bg-[#00F0FF] selection:text-black">
        {/* HEADER - Agora com botão de Voltar */}
        <header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center border-b border-white/5 pb-6">
          <div className="flex flex-col">
            <button onClick={resetApp} className="flex items-center gap-1 text-slate-500 hover:text-[#00F0FF] transition-colors text-sm font-semibold mb-4 w-fit">
              <ChevronRight className="w-4 h-4 rotate-180" /> Analisar outro PDF
            </button>
            <h1 className="text-3xl font-bold text-white flex items-center gap-3">
              <Zap className="text-[#00F0FF] w-8 h-8 drop-shadow-[0_0_8px_rgba(0,240,255,0.8)]" />
              {dashboardData.companyName || 'Intelligence Hub'}
            </h1>
            <p className="text-slate-500 mt-1 ml-11 text-sm tracking-widest uppercase">
              Gerado via Nexus AI • {fileData?.name}
            </p>
          </div>
          <div className="mt-4 md:mt-0 flex items-center gap-4">
            <div className="flex items-center gap-2 bg-[#151A23] border border-white/10 px-4 py-2 rounded-full shadow-[0_0_15px_rgba(176,38,255,0.1)]">
              <CheckCircle2 className="w-4 h-4 text-[#B026FF]" />
              <span className="text-xs font-semibold text-[#B026FF] tracking-wider hidden sm:inline-block">EXTRAÇÃO CONCLUÍDA</span>
            </div>
            <button 
              onClick={handleDownloadHtml}
              className="flex items-center gap-2 bg-[#00F0FF]/10 hover:bg-[#00F0FF]/20 text-[#00F0FF] border border-[#00F0FF]/30 px-4 py-2 rounded-full transition-all duration-300 shadow-[0_0_10px_rgba(0,240,255,0.2)] hover:shadow-[0_0_20px_rgba(0,240,255,0.4)]"
            >
              <Download className="w-4 h-4" />
              <span className="text-xs font-bold tracking-wider">BAIXAR DASHBOARD (HTML)</span>
            </button>
          </div>
        </header>

        {/* --- O RESTANTE DO DASHBOARD MANTÉM A ESTRUTURA ANTERIOR (mas consumindo `dashboardData`) --- */}
        
        {/* KPI CARDS */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative overflow-hidden group hover:border-[#00F0FF]/30 transition-colors">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#00F0FF] to-transparent opacity-50"></div>
            <div className="flex justify-between items-start">
              <div>
                <p className="text-slate-500 text-xs font-bold tracking-widest uppercase mb-1">Capacidade Total</p>
                <h3 className="text-4xl font-black text-white">{dashboardData.totalCapacity} <span className="text-lg text-[#00F0FF]">MW</span></h3>
              </div>
              <div className="p-3 bg-[#00F0FF]/10 rounded-xl"><TrendingUp className="text-[#00F0FF] w-6 h-6" /></div>
            </div>
          </div>
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative overflow-hidden group hover:border-[#0066FF]/30 transition-colors">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#0066FF] to-transparent opacity-50"></div>
            <div className="flex justify-between items-start">
              <div>
                <p className="text-slate-500 text-xs font-bold tracking-widest uppercase mb-1">Geração Hídrica</p>
                <h3 className="text-3xl font-black text-white">{dashboardData.hydroCapacity} <span className="text-lg text-[#0066FF]">MW</span></h3>
              </div>
              <div className="p-3 bg-[#0066FF]/10 rounded-xl"><Droplet className="text-[#0066FF] w-6 h-6" /></div>
            </div>
          </div>
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative overflow-hidden group hover:border-[#B026FF]/30 transition-colors">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-[#B026FF] to-transparent opacity-50"></div>
            <div className="flex justify-between items-start">
              <div>
                <p className="text-slate-500 text-xs font-bold tracking-widest uppercase mb-1">Complexo Solar</p>
                <h3 className="text-3xl font-black text-white">{dashboardData.solarCapacity} <span className="text-lg text-[#B026FF]">MWp</span></h3>
              </div>
              <div className="p-3 bg-[#B026FF]/10 rounded-xl"><Sun className="text-[#B026FF] w-6 h-6" /></div>
            </div>
          </div>
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 relative overflow-hidden group hover:border-slate-400/30 transition-colors">
             <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-400 to-transparent opacity-50"></div>
            <div className="flex justify-between items-start">
              <div>
                <p className="text-slate-500 text-xs font-bold tracking-widest uppercase mb-1">Usinas Ativas</p>
                <h3 className="text-3xl font-black text-white">{dashboardData.activePlants} <span className="text-lg text-slate-400">Ativos</span></h3>
              </div>
              <div className="p-3 bg-slate-700/30 rounded-xl"><ShieldCheck className="text-slate-300 w-6 h-6" /></div>
            </div>
          </div>
        </div>

        {/* BLOCO TEXTUAL */}
        <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 mb-8 shadow-[0_4px_20px_rgba(0,0,0,0.5)] relative z-20">
          <h2 className="text-lg font-semibold text-white mb-6 border-b border-white/10 pb-4">Entidades Identificadas no Documento</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div className="flex gap-4 items-start group"><div className="p-3 bg-slate-800/50 rounded-lg"><ShieldCheck className="text-[#00F0FF] w-5 h-5" /></div><div><h4 className="text-white font-medium mb-1">Comercialização</h4><p className="text-sm text-slate-400 leading-relaxed">Experiência consolidada formando a base de clientes e mitigação de risco no mercado livre.</p></div></div>
            <div className="flex gap-4 items-start group"><div className="p-3 bg-slate-800/50 rounded-lg"><Sun className="text-[#B026FF] w-5 h-5" /></div><div><h4 className="text-white font-medium mb-1">Renováveis & PPAs</h4><p className="text-sm text-slate-400 leading-relaxed">Desenvolvimento focado em contratos de longo prazo (PPAs), assegurando previsibilidade estrutural.</p></div></div>
            <div className="flex gap-4 items-start group"><div className="p-3 bg-slate-800/50 rounded-lg"><Zap className="text-emerald-400 w-5 h-5" /></div><div><h4 className="text-white font-medium mb-1">Soluções e Eficiência</h4><p className="text-sm text-slate-400 leading-relaxed">Consultoria corporativa que cria fidelização e complementa o portfólio físico com alto valor.</p></div></div>
            <div className="flex gap-4 items-start group"><div className="p-3 bg-slate-800/50 rounded-lg"><Droplet className="text-[#0066FF] w-5 h-5" /></div><div><h4 className="text-white font-medium mb-1">Operação Hídrica</h4><p className="text-sm text-slate-400 leading-relaxed">Ativos descentralizados (24 usinas) garantindo energia de base contínua e gestão responsável.</p></div></div>
          </div>
        </div>

        {/* CHARTS GRID */}
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 col-span-1 lg:col-span-2 shadow-[0_4px_20px_rgba(0,0,0,0.5)] relative overflow-hidden flex flex-col z-10">
            <div className="absolute -top-32 -right-32 w-64 h-64 bg-[#B026FF]/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div className="flex items-center justify-between mb-4">
              <div className="flex flex-col"><div className="flex items-center gap-2 mb-1"><TrendingUp className="text-[#B026FF] w-5 h-5" /><h2 className="text-lg font-semibold text-white">Evolução Histórica de Capacidade</h2></div><p className="text-xs text-slate-400">Séries temporais extraídas dos relatórios anuais.</p></div>
            </div>
            <div className="h-[320px] w-full relative"><EChart option={getAreaOption()} style={{ width: '100%', height: '100%' }} /></div>
          </div>
          
          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 col-span-1 shadow-[0_4px_20px_rgba(0,0,0,0.5)] flex flex-col z-10 relative">
            <div className="flex flex-col mb-4"><div className="flex items-center gap-2 mb-1"><BarChart3 className="text-[#00F0FF] w-5 h-5" /><h2 className="text-lg font-semibold text-white">Diversificação da Matriz</h2></div><p className="text-xs text-slate-400">Distribuição entre fontes extraídas do balanço.</p></div>
            <div className="h-[320px] w-full relative">
               <EChart option={getDonutOption(dashboardData)} style={{ width: '100%', height: '100%' }} />
               <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-28 h-28 bg-[#00F0FF]/5 blur-2xl rounded-full pointer-events-none"></div>
            </div>
          </div>

          <div className="bg-[#151A23] border border-white/5 rounded-2xl p-6 col-span-1 shadow-[0_4px_20px_rgba(0,0,0,0.5)] flex flex-col z-10 relative">
            <div className="flex flex-col mb-4"><div className="flex items-center gap-2 mb-1"><Activity className="text-emerald-400 w-5 h-5" /><h2 className="text-lg font-semibold text-white">Índice de Maturidade</h2></div><p className="text-xs text-slate-400">Score calculado pela análise de sentimento do texto.</p></div>
            <div className="h-[320px] w-full relative"><EChart option={getRadarOption()} style={{ width: '100%', height: '100%' }} /></div>
          </div>
        </div>
      </div>
    );
  }

  return null;
}
